<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>MIT6.828-OS-lab4:多进程的调度和通信 | Autumn-Cat</title><meta name="description" content="MIT6.828-OS-lab4:多进程的调度和通信"><meta name="keywords" content="MIT-6.828"><meta name="author" content="Autumn-Cat"><meta name="copyright" content="Autumn-Cat"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://yoursite.com/2020/01/27/MIT6-828-OS-lab4/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="MIT6.828-OS-lab4:多进程的调度和通信"><meta name="twitter:description" content="MIT6.828-OS-lab4:多进程的调度和通信"><meta name="twitter:image" content="https://i0.hippopx.com/photos/262/885/283/sunset-boat-sea-ship-thumb.jpg"><meta property="og:type" content="article"><meta property="og:title" content="MIT6.828-OS-lab4:多进程的调度和通信"><meta property="og:url" content="http://yoursite.com/2020/01/27/MIT6-828-OS-lab4/"><meta property="og:site_name" content="Autumn-Cat"><meta property="og:description" content="MIT6.828-OS-lab4:多进程的调度和通信"><meta property="og:image" content="https://i0.hippopx.com/photos/262/885/283/sunset-boat-sea-ship-thumb.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="MIT6-828-OS-lab5:至关重要的文件的系统-简化版" href="http://yoursite.com/2020/02/04/MIT6-828-OS-lab5/"><link rel="next" title="MIT6.828-OS-lab3:内核和用户的互相协作" href="http://yoursite.com/2020/01/07/MIT6-828-OS-lab3/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script><!-- hexo-inject:begin --><!-- hexo-inject:end -->var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script><!-- hexo-inject:begin --><!-- hexo-inject:end --></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Autumn-Cat</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">31</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#多处理器的支持"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">多处理器的支持</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#lock：自旋锁"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">lock：自旋锁</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#循环调度"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">循环调度</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#创建子进程：fork"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">创建子进程：fork</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#dumbfork：愚蠢的fork"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">dumbfork：愚蠢的fork</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#copy-on-write-fork：smarter-fork"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">copy-on-write fork：smarter fork</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#用户态上的-page-fault-handler"><span class="toc_mobile_items-number">2.2.1.</span> <span class="toc_mobile_items-text">用户态上的 page_fault_handler</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#异常栈与env-pgfault-upcall"><span class="toc_mobile_items-number">2.2.2.</span> <span class="toc_mobile_items-text">异常栈与env_pgfault_upcall</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#总结"><span class="toc_mobile_items-number">2.2.2.1.</span> <span class="toc_mobile_items-text">总结</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#FORK"><span class="toc_mobile_items-number">2.2.3.</span> <span class="toc_mobile_items-text">FORK(    )</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#进程间的通信：IPC"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">进程间的通信：IPC</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#硬件中断"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">硬件中断</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#IPC：Inner-Proce-Communication"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">IPC：Inner Proce Communication</span></a></li></ol></li></ol></div></div><div id="body-wrap"><div id="web_bg"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#多处理器的支持"><span class="toc-number">1.</span> <span class="toc-text">多处理器的支持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#lock：自旋锁"><span class="toc-number">1.1.</span> <span class="toc-text">lock：自旋锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#循环调度"><span class="toc-number">1.2.</span> <span class="toc-text">循环调度</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#创建子进程：fork"><span class="toc-number">2.</span> <span class="toc-text">创建子进程：fork</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dumbfork：愚蠢的fork"><span class="toc-number">2.1.</span> <span class="toc-text">dumbfork：愚蠢的fork</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#copy-on-write-fork：smarter-fork"><span class="toc-number">2.2.</span> <span class="toc-text">copy-on-write fork：smarter fork</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#用户态上的-page-fault-handler"><span class="toc-number">2.2.1.</span> <span class="toc-text">用户态上的 page_fault_handler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#异常栈与env-pgfault-upcall"><span class="toc-number">2.2.2.</span> <span class="toc-text">异常栈与env_pgfault_upcall</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FORK"><span class="toc-number">2.2.3.</span> <span class="toc-text">FORK(    )</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#进程间的通信：IPC"><span class="toc-number">3.</span> <span class="toc-text">进程间的通信：IPC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#硬件中断"><span class="toc-number">3.1.</span> <span class="toc-text">硬件中断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPC：Inner-Proce-Communication"><span class="toc-number">3.2.</span> <span class="toc-text">IPC：Inner Proce Communication</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i0.hippopx.com/photos/262/885/283/sunset-boat-sea-ship-thumb.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">MIT6.828-OS-lab4:多进程的调度和通信</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-01-27<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-02-04</time><div class="post-meta-wordcount"><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="&#x591A;&#x5904;&#x7406;&#x5668;&#x7684;&#x652F;&#x6301;"><a href="#&#x591A;&#x5904;&#x7406;&#x5668;&#x7684;&#x652F;&#x6301;" class="headerlink" title="&#x591A;&#x5904;&#x7406;&#x5668;&#x7684;&#x652F;&#x6301;"></a>&#x591A;&#x5904;&#x7406;&#x5668;&#x7684;&#x652F;&#x6301;</h1><p>&#x5F53;&#x5B58;&#x5728;&#x591A;&#x4E2A;&#x5904;&#x7406;&#x5668;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5904;&#x7406;&#x5668;&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#xFF1A;boot &#x5904;&#x7406;&#x5668;&#xFF08;BSP&#xFF09; &#x534F;&#x52A9;&#x5904;&#x7406;&#x5668;&#xFF08;AP&#xFF09;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x901A;&#x8FC7;boot&#x5904;&#x7406;&#x5668;&#x5B8C;&#x6210;&#x57FA;&#x672C;&#x7CFB;&#x7EDF;&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x7136;&#x540E;&#x542F;&#x52A8;&#x5176;&#x5B83;&#x7684;CPU&#x3002;&#x591A;&#x4E2A;CPU&#x5171;&#x4EAB;&#x5185;&#x5B58;&#xFF0C;&#x4F46;&#x662F;&#x62E5;&#x6709;&#x72EC;&#x7ACB;&#x7684;&#x8FD0;&#x884C;&#x5806;&#x6808;&#x3002;env&#x94FE;&#x8868;&#x5C31;&#x6784;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x6C60;&#xFF0C;&#x5F53;CPU&#x7A7A;&#x95F2;&#x65F6;&#xFF0C;&#x4F1A;&#x53BB;&#x904D;&#x5386;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x6C60;&#xFF0C;&#x7136;&#x540E;&#x53BB;&#x6267;&#x884C;&#x5BF9;&#x5E94;&#x8FDB;&#x7A0B;&#x3002;&#xFF08;BSP&#x7531;BOOT&#x6307;&#x5B9A;&#xFF09;</p>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>&#x5BF9;&#x4E8E;Intel CPU&#x800C;&#x8A00;&#xFF0C;&#x6BCF;&#x4E2A;&#x6838;&#x5FC3;&#x90FD;&#x6709;&#x4E00;&#x4E2A;LAPIC&#x5355;&#x5143;&#xFF0C;LAPIC&#x5355;&#x5143;&#x63D0;&#x4F9B;CPU&#x7684;&#x4E00;&#x4E9B;&#x6807;&#x8BC6;&#x4FE1;&#x606F;&#xFF08;&#x6BD4;&#x5982;&#x6BCF;&#x4E2A;&#x6838;&#x5FC3;&#x90FD;&#x6709;&#x4E00;&#x4E2A;&#x552F;&#x4E00;&#x6807;&#x8BC6;ID&#xFF09;&#xFF0C;&#x4EE5;&#x53CA;&#x4F20;&#x9012;&#x4E2D;&#x65AD;&#x7ED9;CPU&#x3002;</p>
<p>LAPIC&#x6620;&#x5C04;&#x7684;&#x7269;&#x7406;&#x5730;&#x5740;&#x662F;0xFE000000&#xFF08;&#x5904;&#x4E8E; lab1 &#x6240;&#x8BF4;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;hole&#x4E2D;&#xFF09;&#xFF0C;&#x5728;&#x5B9E;&#x9A8C;&#x800C;&#x4E2D;&#x6211;&#x4EEC;&#x53EA;&#x5C06;&#x7269;&#x7406;&#x5730;&#x5740;[0,2^32-KENBASE] &#x6620;&#x5C04;&#x5230; [KENBASE,2^32]&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x76F4;&#x63A5;&#x5BFB;&#x5740;LAPIC&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;LAPIC&#x5730;&#x5740;&#x6620;&#x5C04;&#x5230;&#x865A;&#x62DF;&#x5730;&#x5740;&#x7684;MMIO&#x90E8;&#x5206;&#x3002;</p>
<p>&#x9488;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5206;&#x522B;&#x521D;&#x59CB;&#x5316;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x5904;&#x7406;&#x5668;&#x8FD0;&#x884C;&#x7684;&#x6808;</li>
<li>&#x5904;&#x7406;&#x5668;&#x63CF;&#x8FF0;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;TSS&#x6BB5;</li>
<li>&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x6307;&#x9488;</li>
<li>CPU&#x7684;&#x4E00;&#x4E9B;&#x5BC4;&#x5B58;&#x5668;&#xFF1A;&#x6BD4;&#x5982;cr3 gdt lidt&#x7B49;&#x7B49;</li>
</ul>
<p>&#x5728;&#x6B64;&#x6211;&#x4EEC;&#x6574;&#x7406;&#x4E00;&#x4E0B;&#xFF0C;&#x6574;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<ul>
<li>BSP&#x5904;&#x7406;&#x5668;&#x6267;&#x884C;BIOS Bootloader&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x8F6C;&#x5165;&#x5185;&#x6838;&#x5165;&#x53E3;</li>
<li>&#x5728;&#x5185;&#x6838;&#x5165;&#x53E3;&#x5904;init &#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x8BE5;CPU&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x57FA;&#x672C;&#x7684;&#x521D;&#x59CB;&#x5316;&#xFF1A;</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cons_init();</span><br><span class="line">cprintf(<span class="string">&quot;\n6828 decimal is %o octal!\n&quot;</span>, <span class="number">6828</span>);</span><br><span class="line"><span class="comment">// Lab 2 memory management initialization functions</span></span><br><span class="line">mem_init();</span><br><span class="line"><span class="comment">// Lab 3 user environment initialization functions</span></span><br><span class="line">env_init();</span><br><span class="line">trap_init();</span><br><span class="line"><span class="comment">// Lab 4 multiprocessor initialization functions</span></span><br><span class="line">mp_init();</span><br><span class="line">lapic_init();</span><br><span class="line"><span class="comment">// Lab 4 multitasking initialization functions</span></span><br><span class="line">pic_init();</span><br></pre></td></tr></table></figure>
<ul>
<li>boot_aps()&#x5524;&#x9192;&#x5176;&#x5B83;&#x7684;AP&#xFF0C;&#x5E76;&#x4F7F;&#x5F97;&#x5176;&#x5B83;&#x7684;AP&#x5206;&#x5E03;&#x8F6C;&#x5165;&#x5BF9;&#x5E94;&#x7684;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">mp_main(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">// We are in high EIP now, safe to switch to kern_pgdir </span></span><br><span class="line">	lcr3(PADDR(kern_pgdir));</span><br><span class="line">	cprintf(<span class="string">&quot;SMP: CPU %d starting\n&quot;</span>, cpunum());</span><br><span class="line">	lapic_init();</span><br><span class="line">	env_init_percpu();</span><br><span class="line">	trap_init_percpu();</span><br><span class="line">	xchg(&amp;thiscpu-&gt;cpu_status, CPU_STARTED); <span class="comment">// tell boot_aps() we&apos;re up</span></span><br><span class="line">	<span class="comment">// Now that we have finished some basic setup, call sched_yield()</span></span><br><span class="line">	<span class="comment">// to start running processes on this CPU.  But make sure that</span></span><br><span class="line">	<span class="comment">// only one CPU can enter the scheduler at a time!</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Your code here:</span></span><br><span class="line">	lock_kernel();</span><br><span class="line">	sched_yield();</span><br><span class="line">	<span class="comment">// Remove this after you finish Exercise 6</span></span><br><span class="line">	<span class="comment">// for (;;);</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="lock&#xFF1A;&#x81EA;&#x65CB;&#x9501;"><a href="#lock&#xFF1A;&#x81EA;&#x65CB;&#x9501;" class="headerlink" title="lock&#xFF1A;&#x81EA;&#x65CB;&#x9501;"></a>lock&#xFF1A;&#x81EA;&#x65CB;&#x9501;</h2><p>&#x4E3A;&#x4E86;&#x9632;&#x6B62;&#x591A;CPU&#x51FA;&#x73B0;&#x7684;&#x7ADE;&#x4E89;&#x60C5;&#x51B5;&#xFF0C;&#x6211;&#x4EEC;&#x4F7F;&#x5F97;&#x53EA;&#x80FD;&#x6709;&#x4E00;&#x4E2A;CPU&#x5904;&#x4E8E;&#x5185;&#x6838;&#x6001;&#x3002;&#x5176;&#x5B9E;&#x73B0;&#x673A;&#x5236;&#x5C31;&#x662F;&#x9501;&#xFF0C;&#x9501;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;&#x4E00;&#x5757;&#x5185;&#x5B58;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spin_lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// The xchg is atomic.</span></span><br><span class="line">	<span class="comment">// It also serializes, so that reads after acquire are not</span></span><br><span class="line">	<span class="comment">// reordered before it. </span></span><br><span class="line">	<span class="keyword">while</span> (xchg(&amp;lk-&gt;locked, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">		<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(<span class="string">&quot;pause&quot;</span>)</span></span>;   </span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spin_unlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    xchg(&amp;lk-&gt;locked, <span class="number">0</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x6BCF;&#x4E2A;CPU&#x8FDB;&#x5165;&#x5185;&#x6838;&#x6001;&#x7684;&#x65F6;&#x5019;&#x90FD;&#x8981;&#x52A0;&#x9501;&#xFF0C;&#x51FA;&#x5185;&#x6838;&#x6001;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x89E3;&#x9501;&#xFF1A;</p>
<ul>
<li>&#x5728;BSP&#x4E00;&#x5F00;&#x59CB;&#x8FDB;&#x5165;&#x5185;&#x6838;&#x6001;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x52A0;&#x9501;&#xFF1A;init()</li>
<li>&#x5728;AP&#x4E00;&#x5F00;&#x59CB;&#x8FDB;&#x5165;&#x5185;&#x6838;&#x6001;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x52A0;&#x9501;&#xFF1A;mp_main()</li>
<li>&#x5728;&#x901A;&#x8FC7;&#x5F02;&#x5E38;&#x8FDB;&#x5165;&#x5185;&#x6838;&#x6001;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x52A0;&#x9501;&#xFF1A;trap()</li>
<li>&#x5728;run&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x6001;&#x7A0B;&#x5E8F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x89E3;&#x9501;&#xFF1A;env_run()</li>
</ul>
<h2 id="&#x5FAA;&#x73AF;&#x8C03;&#x5EA6;"><a href="#&#x5FAA;&#x73AF;&#x8C03;&#x5EA6;" class="headerlink" title="&#x5FAA;&#x73AF;&#x8C03;&#x5EA6;"></a>&#x5FAA;&#x73AF;&#x8C03;&#x5EA6;</h2><p>&#x6211;&#x4EEC;&#x5C06;envs&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x6C60;&#x3002;&#x5F53;CPU&#x9700;&#x8981;&#x8C03;&#x5EA6;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5411;&#x540E;&#x5FAA;&#x73AF;&#x904D;&#x5386;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x6C60;&#xFF0C;&#x8FD0;&#x884C;&#x4E0B;&#x4E00;&#x4E2A;&#x53EF;&#x8FD0;&#x884C;&#x7684;&#x8FDB;&#x7A0B;&#xFF08;&#x5982;&#x679C;&#x6CA1;&#x6709;&#xFF0C;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#x672C;&#x8FDB;&#x7A0B;&#xFF09;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">sched_yield(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">idle</span>;</span></span><br><span class="line">	idle = thiscpu-&gt;cpu_env;</span><br><span class="line">	<span class="keyword">size_t</span> cur_id = (idle != <span class="literal">NULL</span>)?ENVX(idle-&gt;env_id):<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= NENV; i++ )</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">int</span> id = (cur_id + i)%NENV;</span><br><span class="line">		<span class="keyword">if</span>(envs[id].env_status == ENV_RUNNABLE)</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">if</span>(idle &amp;&amp; idle-&gt;env_status == ENV_RUNNING)</span><br><span class="line">				idle-&gt;env_status = ENV_RUNNABLE;</span><br><span class="line">			envs[id].env_cpunum = thiscpu-&gt;cpu_id;</span><br><span class="line">			envs[id].env_status = ENV_RUNNING;</span><br><span class="line">			thiscpu-&gt;cpu_env = &amp;envs[id];</span><br><span class="line">			env_run(&amp;envs[id]);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(idle &amp;&amp; idle-&gt;env_status == ENV_RUNNING)</span><br><span class="line">		env_run(thiscpu-&gt;cpu_env);</span><br><span class="line">	<span class="comment">// sched_halt never returns</span></span><br><span class="line">	sched_halt();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h1 id="&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#xFF1A;fork"><a href="#&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#xFF1A;fork" class="headerlink" title="&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#xFF1A;fork"></a>&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#xFF1A;fork</h1><p>&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#xFF0C;&#x5B83;&#x7684;&#x5185;&#x5B58;&#x5206;&#x5E03;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">* Virtual memory <span class="built_in">map</span>:                                Permissions</span><br><span class="line">*                                                    kernel/user</span><br><span class="line">*    <span class="number">4</span> Gig --------&gt;  +------------------------------+</span><br><span class="line">*                     |                              | RW/--</span><br><span class="line">*                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">*                     :              .               :</span><br><span class="line">*                     :              .               :</span><br><span class="line">*                     :              .               :</span><br><span class="line">*                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~| RW/--</span><br><span class="line">*                     |                              | RW/--</span><br><span class="line">*                     |   Remapped Physical Memory   | RW/--</span><br><span class="line">*                     |                              | RW/--</span><br><span class="line">*    KERNBASE, ----&gt;  +------------------------------+ <span class="number">0xf0000000</span>      --+</span><br><span class="line">*    KSTACKTOP        |     CPU0&apos;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line">*                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line">*                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line">*                     +------------------------------+                   |</span><br><span class="line">*                     |     CPU1&apos;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line">*                     | - - - - - - - - - - - - - - -|                 PTSIZE</span><br><span class="line">*                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line">*                     +------------------------------+                   |</span><br><span class="line">*                     :              .               :                   |</span><br><span class="line">*                     :              .               :                   |</span><br><span class="line">*    MMIOLIM ------&gt;  +------------------------------+ <span class="number">0xefc00000</span>      --+</span><br><span class="line">*                     |       Memory-mapped I/O      | RW/--  PTSIZE</span><br><span class="line">* ULIM, MMIOBASE --&gt;  +------------------------------+ <span class="number">0xef800000</span></span><br><span class="line">*                     |  Cur. Page Table (User R-)   | R-/R-  PTSIZE</span><br><span class="line">*    UVPT      ----&gt;  +------------------------------+ <span class="number">0xef400000</span></span><br><span class="line">*                     |          RO PAGES            | R-/R-  PTSIZE</span><br><span class="line">*    UPAGES    ----&gt;  +------------------------------+ <span class="number">0xef000000</span></span><br><span class="line">*                     |           RO ENVS            | R-/R-  PTSIZE</span><br><span class="line">* UTOP,UENVS ------&gt;  +------------------------------+ <span class="number">0xeec00000</span></span><br><span class="line">* UXSTACKTOP -/       |     User Exception Stack     | RW/RW  PGSIZE</span><br><span class="line">*                     +------------------------------+ <span class="number">0xeebff000</span></span><br><span class="line">*                     |       Empty Memory (*)       | --/--  PGSIZE</span><br><span class="line">*    USTACKTOP  ---&gt;  +------------------------------+ <span class="number">0xeebfe000</span></span><br><span class="line">*                     |      Normal User Stack       | RW/RW  PGSIZE</span><br><span class="line">*                     +------------------------------+ <span class="number">0xeebfd000</span></span><br><span class="line">*                     |                              |</span><br><span class="line">*                     |                              |</span><br><span class="line">*                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">*                     .                              .</span><br><span class="line">*                     .                              .</span><br><span class="line">*                     .                              .</span><br><span class="line">*                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|</span><br><span class="line">*                     |     Program Data &amp; Heap      |</span><br><span class="line">*    UTEXT --------&gt;  +------------------------------+ <span class="number">0x00800000</span></span><br><span class="line">*    PFTEMP -------&gt;  |       Empty Memory (*)       |        PTSIZE</span><br><span class="line">*                     |                              |</span><br><span class="line">*    UTEMP --------&gt;  +------------------------------+ <span class="number">0x00400000</span>      --+</span><br><span class="line">*                     |       Empty Memory (*)       |                   |</span><br><span class="line">*                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line">*                     |  User STAB Data (optional)   |                 PTSIZE</span><br><span class="line">*    USTABDATA ----&gt;  +------------------------------+ <span class="number">0x00200000</span>        |</span><br><span class="line">*                     |       Empty Memory (*)       |                   |</span><br><span class="line">*    <span class="number">0</span> ------------&gt;  +------------------------------+                 --+</span><br></pre></td></tr></table></figure>

<p>&#x6BCF;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;UTOP&#x4E4B;&#x4E0A;&#x6620;&#x5C04;&#x7684;&#x7269;&#x7406;&#x5185;&#x5B58;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF08;Cur. Page Table&#x9664;&#x5916;&#xFF0C;&#x5B83;&#x6620;&#x5C04;&#x7684;&#x662F;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;PDT&#xFF09;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;fork&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x5BF9;UTOP&#x4EE5;&#x4E0B;&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;[UTEXT-UTOP] &#x91CD;&#x65B0;&#x5206;&#x914D;&#x7269;&#x7406;&#x5185;&#x5B58;&#x3002;</p>
<h2 id="dumbfork&#xFF1A;&#x611A;&#x8822;&#x7684;fork"><a href="#dumbfork&#xFF1A;&#x611A;&#x8822;&#x7684;fork" class="headerlink" title="dumbfork&#xFF1A;&#x611A;&#x8822;&#x7684;fork"></a>dumbfork&#xFF1A;&#x611A;&#x8822;&#x7684;fork</h2><p>&#x5728;&#x5B9E;&#x73B0;fork&#x51FD;&#x6570;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x51E0;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF08;fork&#x662F;&#x7528;&#x6237;&#x6001;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x9700;&#x8981;&#x501F;&#x52A9;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6765;&#x5B9E;&#x73B0;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x521B;&#x5EFA;&#xFF09;&#xFF1A;</p>
<ul>
<li>sys_exofork(void)&#xFF1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;env &#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF08;&#x62F7;&#x8D1D;&#x7236;&#x8FDB;&#x7A0B;env&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x3001;&#x9875;&#x8868; &#x7B49;&#x6570;&#x636E;&#xFF0C;&#x8BBE;&#x7F6E;&#x4E3A;&#x4E0D;&#x53EF;&#x8FD0;&#x884C;&#xFF09;&#xFF1B;&#x5E76;&#x5C06;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#xFF08;eax&#xFF09;&#x8BBE;&#x4E3A;0&#xFF0C;&#x7236;&#x8FDB;&#x7A0B;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x8BBE;&#x7F6E;&#x4E3A;id</li>
<li>sys_env_set_status(envid_t envid, int status)&#xFF1A;&#x8BBE;&#x7F6E;envid&#x8FDB;&#x7A0B;&#x7684;status</li>
<li>sys_page_alloc(envid_t envid, void *va, int perm)&#xFF1A;&#x5C06;envid&#x8FDB;&#x7A0B;&#x7684;va&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF08;&#x9875;&#x5BF9;&#x9F50;&#xFF09;&#x5206;&#x914D;&#x4E00;&#x4E2A;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x6743;&#x9650;&#x662F;pern</li>
<li>sys_page_map(envid_t srcenvid, void *srcva,envid_t dstenvid, void *dstva, int perm)&#xFF1A;dst&#x8FDB;&#x7A0B;&#x4E2D;&#x7684;dstva &#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x5206;&#x914D;&#x7684;&#x7269;&#x7406;&#x9875;  src&#x8FDB;&#x7A0B;&#x4E2D;srcva&#x865A;&#x62DF;&#x5730;&#x5740;&#x5BF9;&#x5E94;&#x7684;&#x9875;</li>
<li>sys_page_unmap(envid_t envid, void *va)&#xFF1A;&#x5C06;envid &#x4E2D;va &#x548C;&#x5B83;&#x7684;&#x7269;&#x7406;&#x9875;&#x89E3;&#x7ED1;</li>
</ul>
<p>&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x611A;&#x8822;&#x7684;fork </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">dumbfork(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">envid_t</span> envid;</span><br><span class="line">	<span class="keyword">uint8_t</span> *addr;</span><br><span class="line">	<span class="keyword">int</span> r;</span><br><span class="line">	<span class="keyword">extern</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> end[];</span><br><span class="line">	envid = sys_exofork();</span><br><span class="line">	<span class="keyword">if</span> (envid &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;sys_exofork: %e&quot;</span>, envid);</span><br><span class="line">	<span class="keyword">if</span> (envid == <span class="number">0</span>) {</span><br><span class="line">		thisenv = &amp;envs[ENVX(sys_getenvid())];</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	}</span><br><span class="line">    <span class="comment">//duppage&#x51FD;&#x6570;&#x662F; &#x590D;&#x5236;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;addr&#x5BF9;&#x5E94;&#x7684;&#x9875;  &#x5E76;&#x5C06;&#x5176;&#x6620;&#x5C04;&#x5230; envid&#x8FDB;&#x7A0B;&#x7684;addr&#x4E2D;&#x53BB;</span></span><br><span class="line">	<span class="keyword">for</span> (addr = (<span class="keyword">uint8_t</span>*) UTEXT; addr &lt; end; addr += PGSIZE)</span><br><span class="line">		duppage(envid, addr);</span><br><span class="line">	duppage(envid, ROUNDDOWN(&amp;addr, PGSIZE));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((r = sys_env_set_status(envid, ENV_RUNNABLE)) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;sys_env_set_status: %e&quot;</span>, r);</span><br><span class="line">	<span class="keyword">return</span> envid;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>



<h2 id="copy-on-write-fork&#xFF1A;smarter-fork"><a href="#copy-on-write-fork&#xFF1A;smarter-fork" class="headerlink" title="copy-on-write fork&#xFF1A;smarter fork"></a>copy-on-write fork&#xFF1A;smarter fork</h2><p>&#x7269;&#x7406;&#x9875;&#x7684;&#x590D;&#x5236;&#x5F00;&#x9500;&#x662F;&#x5F88;&#x5927;&#x7684;&#xFF1B;&#x800C;&#x6211;&#x4EEC;&#x5728;fork&#x4E00;&#x4E2A;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5F80;&#x5F80;&#x4F1A;&#x8C03;&#x7528;exec&#x51FD;&#x6570;&#xFF08;&#x5728;JOS&#x4E2D;&#x5C31;&#x7B97;env_create&#xFF09;&#x53BB;&#x91CD;&#x65B0;&#x52A0;&#x8F7D;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;&#x4E4B;&#x524D;&#x7684;&#x590D;&#x5236;&#x5C31;&#x662F;&#x6CA1;&#x6709;&#x5FC5;&#x8981;&#x7684;&#x3002;</p>
<p>&#x6240;&#x4EE5;&#x4E00;&#x4E2A;&#x66F4;&#x806A;&#x660E;&#x7684;&#x529E;&#x6CD5;&#x662F;copy-on-write fork&#xFF1A;&#x6211;&#x4EEC;&#x5E76;&#x4E0D;&#x590D;&#x5236;&#x7269;&#x7406;&#x9875;&#xFF0C;&#x800C;&#x662F;&#x5C06;&#x8FD9;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x8BBE;&#x7F6E;&#x4E3A;COW&#x6743;&#x9650;&#xFF08;&#x5982;&#x679C;&#x6709;W&#x6743;&#x9650;&#x7684;&#x8BDD;&#xFF09;&#xFF0C;&#x8FD9;&#x6837;&#x5F53;&#x6709;&#x8FDB;&#x7A0B;&#x5C1D;&#x8BD5;&#x53BB;&#x6539;&#x53D8;&#x8FD9;&#x4E2A;&#x7269;&#x7406;&#x9875;&#x7684;&#x5185;&#x5BB9;&#x7684;&#x65F6;&#x5019;&#xFF08;write&#xFF09;&#xFF0C;&#x624D;&#x53BB;&#x590D;&#x5236;&#x8FD9;&#x4E2A;&#x7269;&#x7406;&#x9875;&#xFF08;copy&#xFF09;&#x3002;</p>
<h3 id="&#x7528;&#x6237;&#x6001;&#x4E0A;&#x7684;-page-fault-handler"><a href="#&#x7528;&#x6237;&#x6001;&#x4E0A;&#x7684;-page-fault-handler" class="headerlink" title="&#x7528;&#x6237;&#x6001;&#x4E0A;&#x7684; page_fault_handler"></a>&#x7528;&#x6237;&#x6001;&#x4E0A;&#x7684; page_fault_handler</h3><p>&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x7684;&#x5904;&#x7406;&#x4E86;&#x4E00;&#x4E0B;page_fault&#xFF1A;&#x5F53;&#x5185;&#x6838;&#x51FA;&#x73B0;page_fault&#x7684;&#x65F6;&#x5019;&#xFF0C;panic&#xFF1B;&#x5F53;&#x8FDB;&#x7A0B;&#x51FA;&#x73B0;&#x7684;&#x65F6;&#x5019;&#xFF0C;destroy&#x5B83;&#x3002;</p>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x8003;&#x8651;&#x8FDB;&#x7A0B;&#x51FA;&#x73B0;page_fault&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5728;UNIX&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x5904;&#x7406;&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x548C;&#x5904;&#x4E8E;&#x8FDB;&#x7A0B;&#x4E0D;&#x540C;&#x7684;&#x6BB5;&#x6709;&#x5173;&#x7684;</p>
<blockquote>
<p>A typical Unix kernel must keep track of what action to take when a page fault occurs in each region of a process&#x2019;s space. </p>
<p>For example, a fault in the stack region will typically allocate and map new page of physical memory.</p>
<p>A fault in the program&#x2019;s BSS region will typically allocate a new page, fill it with zeroes, and map it. </p>
<p>In systems with demand-paged executables, a fault in the text region will read the corresponding page of the binary off of disk and then map it.</p>
</blockquote>
<p>UNIX&#x5185;&#x6838;&#x9700;&#x8981;&#x8FFD;&#x8E2A;&#x5927;&#x91CF;&#x7684;&#x4FE1;&#x606F;&#x3002;&#x800C;&#x5728;JOS&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x81EA;&#x5DF1;&#x51B3;&#x5B9A;&#x5BF9;&#x6BCF;&#x4E00;&#x4E2A;&#x9875;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#x3002;</p>
<h3 id="&#x5F02;&#x5E38;&#x6808;&#x4E0E;env-pgfault-upcall"><a href="#&#x5F02;&#x5E38;&#x6808;&#x4E0E;env-pgfault-upcall" class="headerlink" title="&#x5F02;&#x5E38;&#x6808;&#x4E0E;env_pgfault_upcall"></a>&#x5F02;&#x5E38;&#x6808;&#x4E0E;env_pgfault_upcall</h3><p>&#x6211;&#x4EEC;&#x4F7F;&#x5F97;&#x6BCF;&#x4E00;&#x4E2A;env &#x7ED1;&#x5B9A;&#x4E00;&#x4E2A;env_pgfault_upcall&#xFF0C;&#x4F5C;&#x4E3A;pgfault&#x5F02;&#x5E38;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x5B83;&#x7684;&#x8C03;&#x7528;&#x673A;&#x5236;&#x662F;&#xFF1A;</p>
<ul>
<li>env &#x5F15;&#x53D1;pgfault&#xFF0C;&#x8FDB;&#x5165;&#x5185;&#x6838;&#x6001;&#x7684;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x673A;&#x5236;&#x4E2D;&#xFF08;&#x8BE6;&#x89C1;lab4&#xFF09;</li>
<li>&#x5728;page_fault_handler(struct Trapframe *tf)&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x4FDD;&#x5B58;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x5230;&#x5F02;&#x5E38;&#x6808;&#x4E2D;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x4E0B;&#x4E00;&#x6761;&#x6267;&#x884C;&#x7684;&#x547D;&#x4EE4;&#x662F;upcall&#x51FD;&#x6570;</li>
<li>&#x91CD;&#x65B0;&#x8FD4;&#x56DE;&#x7528;&#x6237;&#x6001;&#xFF0C;&#x6267;&#x884C;up_call&#x51FD;&#x6570;</li>
</ul>
<p>&#x5F02;&#x5E38;&#x6808;&#x662F;UXSTACKTOP&#x4E0B;&#x7684;&#x4E00;&#x9875;&#xFF0C;&#x5728;&#x5F02;&#x5E38;&#x6808;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4FDD;&#x5B58;&#x4EE5;&#x4E0B;&#x4FE1;&#x606F;&#xFF08;&#x4E00;&#x4E2A;UTrapframe&#xFF09;&#xFF0C;&#x5E76;&#x4E14;&#x5F53;&#x51FA;&#x73B0;&#x9012;&#x5F52;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;fault_va&#x4E0B;&#x9762;&#x7A7A;4&#x4E2A;&#x7A7A;&#x767D;&#x5B57;&#x8282;&#xFF0C;&#x7EE7;&#x7EED;&#x4FDD;&#x5B58;&#x4E0B;&#x4E00;&#x4E2A;UTF&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">                    &lt;-- UXSTACKTOP</span><br><span class="line">trap-time esp</span><br><span class="line">trap-time eflags</span><br><span class="line">trap-time eip</span><br><span class="line">trap-time eax       start of <span class="class"><span class="keyword">struct</span> <span class="title">PushRegs</span></span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">ecx</span></span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">edx</span></span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">ebx</span></span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">esp</span></span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">ebp</span></span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">esi</span></span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">edi</span>       <span class="title">end</span> <span class="title">of</span> <span class="title">struct</span> <span class="title">PushRegs</span></span></span><br><span class="line"><span class="class"><span class="title">tf_err</span> (<span class="title">error</span> <span class="title">code</span>)</span></span><br><span class="line"><span class="class"><span class="title">fault_va</span>            &lt;-- %esp when handler is run</span></span><br></pre></td></tr></table></figure>

<p>&#x6240;&#x4EE5;&#xFF0C;page_fault_handler&#x7684;&#x51FD;&#x6570;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(curenv-&gt;env_pgfault_upcall)</span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">UTrapframe</span> *<span class="title">utf</span>;</span></span><br><span class="line">    <span class="keyword">if</span>(tf-&gt;tf_esp &lt; UXSTACKTOP &amp;&amp; tf-&gt;tf_esp &gt;= UXSTACKTOP-PGSIZE)</span><br><span class="line">        utf = (struct UTrapframe *)(tf-&gt;tf_esp - <span class="number">4</span> - <span class="keyword">sizeof</span>(struct UTrapframe));</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        utf = (struct UTrapframe *)(UXSTACKTOP - <span class="keyword">sizeof</span>(struct UTrapframe));</span><br><span class="line">    user_mem_assert(curenv, (<span class="keyword">void</span> *)utf, <span class="keyword">sizeof</span>(struct UTrapframe), PTE_U | PTE_W);</span><br><span class="line">    <span class="comment">//&#x521D;&#x59CB;&#x5316;utf</span></span><br><span class="line">    utf-&gt;utf_fault_va = fault_va;</span><br><span class="line">    utf-&gt;utf_err = tf-&gt;tf_err;</span><br><span class="line">    utf-&gt;utf_eip = tf-&gt;tf_eip;</span><br><span class="line">    utf-&gt;utf_eflags = tf-&gt;tf_eflags;</span><br><span class="line">    utf-&gt;utf_esp = tf-&gt;tf_esp;</span><br><span class="line">    utf-&gt;utf_regs = tf-&gt;tf_regs;</span><br><span class="line">    <span class="comment">//&#x4F7F;&#x5F97;curenv&#x8F6C;&#x5411;env_pgfault_upcall&#x5904;&#x7406;&#xFF0C;&#x6808;&#x662F;&#x5411;&#x4E0B;&#x751F;&#x957F;</span></span><br><span class="line">    tf-&gt;tf_eip = (<span class="keyword">uintptr_t</span>)curenv-&gt;env_pgfault_upcall;</span><br><span class="line">    tf-&gt;tf_esp = (<span class="keyword">uintptr_t</span>)utf;</span><br><span class="line">    env_run(curenv);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF08;&#x4E2D;&#x65AD;+5&#x4E2A;&#x53C2;&#x6570;&#xFF09;&#x6765;&#x8BBE;&#x7F6E;upcall&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sys_env_set_pgfault_upcall(<span class="keyword">envid_t</span> envid, <span class="keyword">void</span> *func)</span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">env</span>;</span></span><br><span class="line">	<span class="keyword">if</span>(envid2env(envid,&amp;env,<span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">	env-&gt;env_pgfault_upcall = func;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>env_pgfault_upcall &#x7684;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x5982;&#x4E0B;&#xFF1A;</p>
<ul>
<li>&#x8C03;&#x7528;envid &#x7684;handler&#x51FD;&#x6570;(handler&#x51FD;&#x6570;&#x7531;&#x7528;&#x6237;&#x81EA;&#x5DF1;&#x8BBE;&#x7F6E;)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pushl %esp			// function argument: pointer to UTF</span><br><span class="line">movl _pgfault_handler, %eax</span><br><span class="line">call *%eax</span><br><span class="line">addl $4, %esp			// pop function argument</span><br></pre></td></tr></table></figure>

<p>&#x8BBE;&#x7F6E;hanlder&#x7684;&#x5E93;&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">set_pgfault_handler(<span class="keyword">void</span> (*handler)(struct UTrapframe *utf))</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_pgfault_handler == <span class="number">0</span>) {</span><br><span class="line">		<span class="comment">// First time through!</span></span><br><span class="line">		sys_page_alloc(sys_getenvid(),(<span class="keyword">void</span>*)UXSTACKTOP-PGSIZE,PTE_U|PTE_W);</span><br><span class="line">		sys_env_set_pgfault_upcall(sys_getenvid(),_pgfault_upcall);</span><br><span class="line">	}</span><br><span class="line">	_pgfault_handler = handler;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>&#x8FD4;&#x56DE;&#x4E4B;&#x524D;&#x7684;&#x547D;&#x4EE4;&#xFF08;&#x5373;&#x6062;&#x590D;&#x4FDD;&#x5B58;&#x7684;eip&#xFF09;</li>
</ul>
<p>&#x8FD4;&#x56DE;&#x4E4B;&#x524D;&#x7684;&#x547D;&#x4EE4;&#x6709;&#x4E00;&#x4E2A;&#x56F0;&#x96BE;&#x4E4B;&#x5904;&#x5728;&#x4E8E;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x591F;&#x4F7F;&#x7528;jmp&#x6307;&#x4EE4;&#xFF0C;&#x56E0;&#x4E3A;jmp&#x6307;&#x4EE4;&#x9700;&#x8981;&#x5148;&#x628A;&#x5730;&#x5740;&#x52A0;&#x8F7D;&#x5230;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;&#xFF0C;&#x518D;&#x8FDB;&#x884C;&#x8DF3;&#x8F6C;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x591F;&#x6539;&#x53D8;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x503C;&#x3002;</p>
<p>UTrapframe&#x7684;&#x5730;&#x5740;&#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">\/\/\/\/\/\/\       <span class="number">4</span> byte					&lt;-- %esp + <span class="number">52</span></span><br><span class="line">trap-time esp       <span class="number">4</span> byte					&lt;-- %esp + <span class="number">48</span>  &#x9644;&#xFF1A;&#x8FD9;&#x91CC;&#x4FDD;&#x5B58;&#x7684;&#x503C;&#x5C31;&#x7B97;esp+<span class="number">52</span></span><br><span class="line">trap-time eflags    <span class="number">4</span> byte				</span><br><span class="line">trap-time eip	    <span class="number">4</span> byte					&lt;-- %esp + <span class="number">40</span></span><br><span class="line">trap-time eax       start of <span class="class"><span class="keyword">struct</span> <span class="title">PushRegs</span> </span></span><br><span class="line"><span class="class">.............       32 <span class="title">byte</span> </span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">edi</span>       <span class="title">end</span> <span class="title">of</span> <span class="title">struct</span> <span class="title">PushRegs</span>    &lt;-- %esp + 8</span></span><br><span class="line"><span class="class">tf_err (error code) 4  byte </span></span><br><span class="line"><span class="class">fault_va            						&lt;-- %esp when handler is run</span></span><br></pre></td></tr></table></figure>

<p>&#x6240;&#x4EE5;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x5C06;&#xFF0C;eip&#x653E;&#x5230;4&#x4E2A;&#x7A7A;&#x767D;&#x5904;&#xFF08;%esp + 56&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x5904;ret&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x591A;&#x5206;&#x914D;&#x4E86;4&#x4E2A;&#x7A7A;&#x767D;&#x5B57;&#x8282;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x8FD8;&#x9700;&#x8981;&#x5C06;esp - 4&#xFF0C;</p>
<p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6267;&#x884C;&#x4E0B;&#x9762;&#x547D;&#x4EE4;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">movl 48(%esp), %ebp</span><br><span class="line">subl $4, %ebp</span><br><span class="line">movl %ebp, 48(%esp)</span><br><span class="line">movl 40(%esp), %eax</span><br><span class="line">movl %eax, (%ebp)</span><br></pre></td></tr></table></figure>

<p>&#x6B64;&#x65F6;&#xFF0C;Utrapframe&#x53D8;&#x4E3A;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">trap-time eip       <span class="number">4</span> byte					&lt;-- %esp + <span class="number">52</span></span><br><span class="line">trap-time esp - <span class="number">4</span>   <span class="number">4</span> byte					&lt;-- %esp + <span class="number">48</span> </span><br><span class="line">trap-time eflags    <span class="number">4</span> byte				</span><br><span class="line">trap-time eip	    <span class="number">4</span> byte					&lt;-- %esp + <span class="number">40</span></span><br><span class="line">trap-time eax       start of <span class="class"><span class="keyword">struct</span> <span class="title">PushRegs</span> </span></span><br><span class="line"><span class="class">.............       32 <span class="title">byte</span> </span></span><br><span class="line"><span class="class"><span class="title">trap</span>-<span class="title">time</span> <span class="title">edi</span>       <span class="title">end</span> <span class="title">of</span> <span class="title">struct</span> <span class="title">PushRegs</span>    &lt;-- %esp + 8</span></span><br><span class="line"><span class="class">tf_err (error code) 4  byte </span></span><br><span class="line"><span class="class">fault_va            						&lt;-- %esp when handler is run</span></span><br></pre></td></tr></table></figure>

<p>&#x7136;&#x540E;&#xFF0C;&#x5E76;&#x662F;&#x6062;&#x590D;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;ret&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">addl $8, %esp</span><br><span class="line">popal</span><br><span class="line"></span><br><span class="line">addl $4, %esp</span><br><span class="line">popfl</span><br><span class="line"></span><br><span class="line">popl %esp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<h4 id="&#x603B;&#x7ED3;"><a href="#&#x603B;&#x7ED3;" class="headerlink" title="&#x603B;&#x7ED3;"></a>&#x603B;&#x7ED3;</h4><p>&#x6700;&#x540E;&#x603B;&#x7ED3;&#x4E00;&#x6CE2;&#x8FD9;&#x4E00;&#x6BB5;&#xFF1A;</p>
<ul>
<li>&#x7528;&#x6237;&#x8BBE;&#x7F6E;hanlder&#xFF08;&#x7B2C;&#x4E00;&#x6B21;&#x8BBE;&#x7F6E;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x5206;&#x914D;&#x5F02;&#x5E38;&#x6808;&#xFF09;</li>
<li>&#x7528;&#x6237;&#x9677;&#x5165;pgfault&#xFF0C;&#x8FDB;&#x5165;&#x5185;&#x6838;</li>
<li>&#x5185;&#x6838;&#x8FD4;&#x56DE;up_call</li>
<li>up_call&#x8C03;&#x7528;handler&#xFF0C;&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x9677;&#x5165;&#x70B9;&#x4E0B;&#x4E00;&#x6761;&#x6307;&#x4EE4;</li>
</ul>
<h3 id="FORK"><a href="#FORK" class="headerlink" title="FORK(    )"></a>FORK(    )</h3><p>&#x7ED5;&#x4E86;&#x8FD9;&#x4E48;&#x4E00;&#x5927;&#x5708;&#xFF0C;&#x7EC8;&#x4E8E;&#x6211;&#x4EEC;&#x6765;&#x5230;&#x4E86;&#x8FD9;fork&#x51FD;&#x6570;&#x3002;</p>
<p>copy on write &#x9700;&#x8981;&#x4E86;&#x89E3;&#x6BCF;&#x4E00;&#x4E2A;&#x9875;&#x7684;&#x6743;&#x9650;&#x3002;&#x5373;&#x9700;&#x8981;&#x8BBF;&#x95EE;&#x9875;&#x8868;&#x9879;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5F15;&#x5165;&#x4E00;&#x4E2A;UVPT&#xFF08;&#x5176;&#x9875;&#x8868;&#x9879;&#x4E3A;V&#xFF09;&#xFF0C;&#x5373;&#x5728;&#x6709;&#x4E00;&#x4E2A;&#x4E00;&#x7EA7;&#x9875;&#x8868;&#x9879;&#xFF08;UVPT&#xFF09;&#x6307;&#x5411;&#x81EA;&#x5DF1;&#x3002;</p>
<p><img alt="img" data-src="/2020/01/27/MIT6-828-OS-lab4/vpt.png" class="lozad"></p>
<p>&#x8FD9;&#x6837;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;va &#x7684; &#x7ED3;&#x6784;&#x662F; V PDX PTX &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x8BBF;&#x95EE;&#x7684;&#x5C31;&#x662F;&#x5BF9;&#x5E94;&#x4E8C;&#x7EA7;&#x9875;&#x8868;&#x9879;&#x7684;&#x503C;&#xFF0C;&#x5373;uvpt[  ]</p>
<p>&#x5F53;&#x4E00;&#x4E2A; va &#x7684; &#x7ED3;&#x6784;&#x662F; V V PDX &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x8BBF;&#x95EE;&#x7684;&#x5C31;&#x7B97;&#x5BF9;&#x5E94;&#x7684;&#x4E00;&#x7EA7;&#x9875;&#x8868;&#x9879;&#xFF0C;uvpd[    ]</p>
<p>&#x8FD9;&#x6837;&#x7684;&#x8BDD;&#xFF0C;fork&#x51FD;&#x6570;&#x5982;&#x4E0B;&#xFF0C;&#x6CE8;&#x610F;&#x5F02;&#x5E38;&#x6808;&#x4E0D;&#x80FD;COW&#x3002;&#x56E0;&#x4E3A;&#x8C03;&#x7528;upcall&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x5199;&#x5165;&#x53C2;&#x6570;&#x5230;&#x5F02;&#x5E38;&#x6808;&#xFF0C;&#x800C;&#x5199;&#x5165;&#x53C2;&#x6570;&#x7684;&#x65F6;&#x5019;&#x53C8;&#x4F1A;&#x89E6;&#x53D1;pgfault&#x4E2D;&#x65AD;&#x3002;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">fork(<span class="keyword">void</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">envid_t</span> envid;</span><br><span class="line">	<span class="keyword">unsigned</span> pn;</span><br><span class="line">	<span class="keyword">int</span> r;</span><br><span class="line">	envid = sys_exofork();</span><br><span class="line">	set_pgfault_handler(pgfault);</span><br><span class="line">	<span class="keyword">if</span> (envid &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;sys_exofork: %e&quot;</span>, envid);</span><br><span class="line">	<span class="keyword">if</span> (envid == <span class="number">0</span>) </span><br><span class="line">	{</span><br><span class="line">		thisenv = &amp;envs[ENVX(sys_getenvid())];</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">for</span> (pn = PGNUM(UTEXT); pn &lt; PGNUM(USTACKTOP); pn++) </span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">if</span> ( (uvpd[pn &gt;&gt; <span class="number">10</span>] &amp; PTE_P) &amp;&amp; (uvpt[pn] &amp; PTE_P))</span><br><span class="line">			<span class="keyword">if</span> ( (r = duppage(envid, pn)) &lt; <span class="number">0</span>)</span><br><span class="line">				panic(<span class="string">&quot;fork:duppage error:%d\n&quot;</span>,r);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//&#x5206;&#x914D;&#x5F02;&#x5E38;&#x6808;</span></span><br><span class="line">	<span class="keyword">if</span>((r = sys_page_alloc(envid,(<span class="keyword">void</span>*)(UXSTACKTOP-PGSIZE),PTE_U|PTE_W)) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;fork:alloc UXSTACK error\n&quot;</span>);</span><br><span class="line">	<span class="keyword">extern</span> <span class="keyword">void</span> _pgfault_upcall(<span class="keyword">void</span>);</span><br><span class="line">	<span class="keyword">if</span> ((r = sys_env_set_pgfault_upcall(envid, _pgfault_upcall)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	<span class="keyword">if</span> ((r = sys_env_set_status(envid, ENV_RUNNABLE)) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;sys_env_set_status: %e&quot;</span>, r);</span><br><span class="line">	<span class="keyword">return</span> envid;</span><br></pre></td></tr></table></figure>

<p>&#x9875;&#x9762;&#x91CD;&#x6620;&#x5C04;&#x51FD;&#x6570;&#x4E3A;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">duppage(<span class="keyword">envid_t</span> envid, <span class="keyword">unsigned</span> pn)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">int</span> r;</span><br><span class="line">	<span class="keyword">envid_t</span> curvid = sys_getenvid();</span><br><span class="line">	<span class="keyword">void</span> *addr = (<span class="keyword">void</span>*)(pn*PGSIZE);</span><br><span class="line">	<span class="keyword">int</span> perm = (uvpt[PGNUM((<span class="keyword">uintptr_t</span>)addr)] &amp; (PTE_COW|PTE_W))?PTE_COW|PTE_U:PTE_U;</span><br><span class="line">	<span class="keyword">if</span>((r = sys_page_map(curvid,(<span class="keyword">void</span> *)(pn*PGSIZE),envid,(<span class="keyword">void</span> *)(pn*PGSIZE),perm)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	<span class="keyword">if</span>((r = sys_page_map(curvid,(<span class="keyword">void</span> *)(pn*PGSIZE),curvid,(<span class="keyword">void</span> *)(pn*PGSIZE),perm)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5BF9;&#x5E94;&#x7684;handler&#x4E3A;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">pgfault(struct UTrapframe *utf)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">void</span> *addr = (<span class="keyword">void</span> *) utf-&gt;utf_fault_va;</span><br><span class="line">	<span class="keyword">uint32_t</span> err = utf-&gt;utf_err;</span><br><span class="line">	<span class="keyword">int</span> r;</span><br><span class="line">	<span class="keyword">if</span>(!(err &amp; FEC_PR) || !(uvpt[PGNUM((<span class="keyword">uintptr_t</span>)addr)] &amp; PTE_COW))</span><br><span class="line">		panic(<span class="string">&quot;pgfault error at %p&quot;</span>,addr);</span><br><span class="line">	<span class="comment">// Allocate a new page, map it at a temporary location (PFTEMP),</span></span><br><span class="line">	<span class="comment">// copy the data from the old page to the new page, then move the new</span></span><br><span class="line">	<span class="comment">// page to the old page&apos;s address.</span></span><br><span class="line">	addr = (<span class="keyword">void</span> *)ROUNDDOWN((<span class="keyword">uintptr_t</span>)addr,PGSIZE);</span><br><span class="line">	<span class="keyword">envid_t</span> curvid = sys_getenvid();</span><br><span class="line">	<span class="keyword">if</span>((r = sys_page_alloc(curvid,PFTEMP,PTE_U | PTE_W)) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;page_fault_hanlder:sys_page_alloc error\n&quot;</span>);</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">void</span> *)PFTEMP,addr,PGSIZE);</span><br><span class="line">	<span class="keyword">if</span>((r = sys_page_unmap(curvid,addr)) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;page_fault_hanlder:sys_panic_unmap error\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>((r = sys_page_map(curvid,PFTEMP,curvid,addr,PTE_U|PTE_W)) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;page_fault_hanlder:sys_panic_map error\n&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>((r = sys_page_unmap(curvid,PFTEMP)) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;page_fault_hanlder:sys_panic_unmap error\n&quot;</span>);</span><br><span class="line">	<span class="comment">// panic(&quot;pgfault not implemented&quot;);</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h1 id="&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#xFF1A;IPC"><a href="#&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#xFF1A;IPC" class="headerlink" title="&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#xFF1A;IPC"></a>&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#xFF1A;IPC</h1><h2 id="&#x786C;&#x4EF6;&#x4E2D;&#x65AD;"><a href="#&#x786C;&#x4EF6;&#x4E2D;&#x65AD;" class="headerlink" title="&#x786C;&#x4EF6;&#x4E2D;&#x65AD;"></a>&#x786C;&#x4EF6;&#x4E2D;&#x65AD;</h2><p>&#x5728;JOS&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x786C;&#x4EF6;&#x4E2D;&#x65AD;&#x3002;&#x4E2D;&#x65AD;&#x8BBE;&#x7F6E;&#x7684;&#x65B9;&#x5F0F;&#x548C;lab2&#x4E00;&#x6837;&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x3002;</p>
<p>&#x9700;&#x8981;&#x8BF4;&#x660E;&#x7684;&#x662F;&#x4E24;&#x70B9;&#xFF1A;</p>
<ul>
<li>&#x4E2D;&#x65AD;&#x7531;&#x4E24;&#x4E2A;MASK &#x8BBE;&#x7F6E;&#xFF0C;IF_MASK&#x4F7F;&#x80FD;&#x4E2D;&#x65AD;&#xFF0C;NMI&#x4F1A;&#x5C4F;&#x853D;&#x4E2D;&#x65AD;&#x3002;IF mask&#x8BBE;&#x7F6E;&#x7684;&#x65B9;&#x5F0F;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x662F;&#x901A;&#x8FC7;&#x4E2D;&#x65AD;&#x95E8;&#x3002;env&#x4E2D;&#x6709;&#x4E00;&#x4E2A;IF_MASK&#xFF0C;&#x8FDB;&#x5165;&#x4E2D;&#x65AD;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x5C4F;&#x853D;IF_MASK&#x4E2D;&#x65AD;&#xFF0C;&#x51FA;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x4F7F;&#x80FD;</li>
<li>&#x65F6;&#x949F;&#x4E2D;&#x65AD; &#x5728;&#x6BCF;&#x4E00;&#x4E2A;&#x65F6;&#x949F;&#x4FE1;&#x53F7;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x4EA7;&#x751F;&#xFF0C;&#x65F6;&#x949F;&#x4E2D;&#x65AD;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x5C31;&#x662F;&#x8C03;&#x5EA6;&#x51FD;&#x6570;&#x3002;&#x5373;&#x6211;&#x4EEC;&#x5728;&#x6BCF;&#x4E00;&#x4E2A;&#x65F6;&#x949F;&#x4E2D;&#x65AD;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x8C03;&#x5EA6;&#xFF0C;&#x9632;&#x6B62;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x72EC;&#x5360;CPU&#x3002;</li>
</ul>
<h2 id="IPC&#xFF1A;Inner-Proce-Communication"><a href="#IPC&#xFF1A;Inner-Proce-Communication" class="headerlink" title="IPC&#xFF1A;Inner Proce Communication"></a>IPC&#xFF1A;Inner Proce Communication</h2><p>&#x8FDB;&#x7A0B;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#x53EF;&#x80FD;&#x6709;&#x4E24;&#x79CD;&#x5F62;&#x5F0F;&#xFF0C;&#x5B83;&#x95E8;&#x90FD;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5B8C;&#x6210;</p>
<ul>
<li>&#x4F20;&#x9012;&#x503C;&#xFF1A;recv&#xFF0C;&#x8FD4;&#x56DE;&#x4F20;&#x9012;&#x7684;&#x503C;&#xFF1B;send&#x4F20;&#x9012;&#x5171;&#x4EAB;&#x7684;&#x503C;</li>
<li>&#x4F20;&#x9012;&#x5185;&#x5B58;&#xFF1A;send &#x4F20;&#x9012;&#x9875;&#x9762;&#x7684;&#x865A;&#x62DF;&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x6620;&#x5C04;&#x5230;&#x5BF9;&#x5E94;envid&#x7684;&#x8FDB;&#x7A0B;&#x4E2D;&#x53BB;</li>
</ul>
<p>&#x4F20;&#x9012;&#x5185;&#x5B58;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">srcva(src vid)--------&gt;|----|&lt;--------dstva(dst vid)</span><br><span class="line">                       |PAGE|     </span><br><span class="line">                       |----|</span><br></pre></td></tr></table></figure>

<p>&#x51E0;&#x4E2A;&#x51FD;&#x6570;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">sys_ipc_try_send(<span class="keyword">envid_t</span> envid, <span class="keyword">uint32_t</span> value, <span class="keyword">void</span> *srcva, <span class="keyword">unsigned</span> perm)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span>* <span class="title">dstenv</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span>* <span class="title">srcpp</span>;</span></span><br><span class="line">	<span class="keyword">pte_t</span> *pte;</span><br><span class="line">	<span class="keyword">if</span>(envid2env(envid,&amp;dstenv,<span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">	<span class="keyword">if</span>(dstenv-&gt;env_ipc_recving == <span class="literal">false</span> || dstenv-&gt;env_ipc_from != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -E_IPC_NOT_RECV;</span><br><span class="line">	<span class="keyword">if</span>((<span class="keyword">uintptr_t</span>)srcva &lt; UTOP)</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">if</span>(PGOFF((<span class="keyword">uintptr_t</span>)srcva))</span><br><span class="line">			<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">		<span class="keyword">if</span>((srcpp = page_lookup(curenv-&gt;env_pgdir,srcva,&amp;pte)) == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">		<span class="keyword">if</span>((perm&amp;PTE_SYSCALL) &lt; (PTE_U|PTE_P) || (perm&amp;~PTE_SYSCALL) != <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">		<span class="keyword">if</span>((perm &amp; PTE_W) &amp;&amp; !(*pte &amp; PTE_W))</span><br><span class="line">			<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">		<span class="keyword">if</span>((<span class="keyword">uintptr_t</span>)(dstenv-&gt;env_ipc_dstva) &lt; UTOP &amp;&amp; page_insert(dstenv-&gt;env_pgdir,srcpp,dstenv-&gt;env_ipc_dstva,perm) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line">	}</span><br><span class="line">	dstenv-&gt;env_ipc_recving = <span class="literal">false</span>;</span><br><span class="line">	dstenv-&gt;env_ipc_from = curenv-&gt;env_id;</span><br><span class="line">	dstenv-&gt;env_ipc_value = value;</span><br><span class="line">	dstenv-&gt;env_ipc_perm = perm;</span><br><span class="line">	dstenv-&gt;env_tf.tf_regs.reg_eax = <span class="number">0</span>;</span><br><span class="line">	dstenv-&gt;env_status = ENV_RUNNABLE;<span class="comment">//return 0</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Block until a value is ready.  Record that you want to receive</span></span><br><span class="line"><span class="comment">// using the env_ipc_recving and env_ipc_dstva fields of struct Env,</span></span><br><span class="line"><span class="comment">// mark yourself not runnable, and then give up the CPU.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If &apos;dstva&apos; is &lt; UTOP, then you are willing to receive a page of data.</span></span><br><span class="line"><span class="comment">// &apos;dstva&apos; is the virtual address at which the sent page should be mapped.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function only returns on error, but the system call will eventually</span></span><br><span class="line"><span class="comment">// return 0 on success.</span></span><br><span class="line"><span class="comment">// Return &lt; 0 on error.  Errors are:</span></span><br><span class="line"><span class="comment">//	-E_INVAL if dstva &lt; UTOP but dstva is not page-aligned.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">sys_ipc_recv(<span class="keyword">void</span> *dstva)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">	<span class="keyword">if</span>((<span class="keyword">uintptr_t</span>)dstva &lt; UTOP &amp;&amp; PGOFF((<span class="keyword">uintptr_t</span>)dstva))</span><br><span class="line">		<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">	curenv-&gt;env_ipc_recving = <span class="literal">true</span>;</span><br><span class="line">	curenv-&gt;env_ipc_dstva = dstva;</span><br><span class="line">	curenv-&gt;env_status = ENV_NOT_RUNNABLE;</span><br><span class="line">	curenv-&gt;env_ipc_from = <span class="number">0</span>;</span><br><span class="line">	sched_yield();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>&#x5E93;&#x51FD;&#x6570;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int32_t</span></span><br><span class="line">ipc_recv(<span class="keyword">envid_t</span> *from_env_store, <span class="keyword">void</span> *pg, <span class="keyword">int</span> *perm_store)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">	<span class="keyword">int</span> r;</span><br><span class="line">	pg = pg == <span class="literal">NULL</span>?(<span class="keyword">void</span> *)UTOP:pg;</span><br><span class="line">	<span class="keyword">if</span>((r = sys_ipc_recv(pg)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	<span class="keyword">if</span>(from_env_store != <span class="literal">NULL</span>)</span><br><span class="line">		*from_env_store = thisenv-&gt;env_ipc_from;</span><br><span class="line">	<span class="keyword">if</span>(perm_store != <span class="literal">NULL</span>)</span><br><span class="line">		*perm_store = thisenv-&gt;env_ipc_perm;</span><br><span class="line">	<span class="keyword">return</span> thisenv-&gt;env_ipc_value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">ipc_send(<span class="keyword">envid_t</span> to_env, <span class="keyword">uint32_t</span> val, <span class="keyword">void</span> *pg, <span class="keyword">int</span> perm)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">	<span class="keyword">int</span> r = <span class="number">-1</span>;</span><br><span class="line">	pg = pg == <span class="literal">NULL</span>?(<span class="keyword">void</span> *)UTOP:pg;</span><br><span class="line">	<span class="keyword">while</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">		r = sys_ipc_try_send(to_env,val,pg,perm);</span><br><span class="line">		<span class="keyword">if</span>(r == -E_IPC_NOT_RECV)</span><br><span class="line">			sys_yield();</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(r &lt; <span class="number">0</span>)</span><br><span class="line">			panic(<span class="string">&quot;ipc send:sys_ipc_try_send error:%d&quot;</span>,r);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>



</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">Autumn-Cat</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/01/27/MIT6-828-OS-lab4/">http://yoursite.com/2020/01/27/MIT6-828-OS-lab4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Autumn-Cat</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MIT-6-828/">MIT-6.828    </a></div><div class="post_share"><div class="social-share" data-image="https://i0.hippopx.com/photos/262/885/283/sunset-boat-sea-ship-thumb.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/02/04/MIT6-828-OS-lab5/"><img class="prev_cover lozad" data-src="https://i0.hippopx.com/photos/856/151/610/panorama-sunrise-dawn-bled-preview.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>MIT6-828-OS-lab5:至关重要的文件的系统-简化版</span></div></a></div><div class="next-post pull-right"><a href="/2020/01/07/MIT6-828-OS-lab3/"><img class="next_cover lozad" data-src="https://i0.hippopx.com/photos/853/145/197/landscape-yacht-sunrise-clouds-thumb.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>MIT6.828-OS-lab3:内核和用户的互相协作</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/01/04/MIT6-828-OS-lab2/" title="MIT6.828-OS-lab2:虚拟地址向物理地址的飞跃"><img class="relatedPosts_cover lozad"data-src="https://i0.hippopx.com/photos/298/434/513/beach-dawn-dusk-ocean-preview.jpg"><div class="relatedPosts_title">MIT6.828-OS-lab2:虚拟地址向物理地址的飞跃</div></a></div><div class="relatedPosts_item"><a href="/2020/01/07/MIT6-828-OS-lab3/" title="MIT6.828-OS-lab3:内核和用户的互相协作"><img class="relatedPosts_cover lozad"data-src="https://i0.hippopx.com/photos/853/145/197/landscape-yacht-sunrise-clouds-thumb.jpg"><div class="relatedPosts_title">MIT6.828-OS-lab3:内核和用户的互相协作</div></a></div><div class="relatedPosts_item"><a href="/2019/12/26/MIT6-828-OS-lab1/" title="MIT6.828-OS-lab1:BIOS、boot和kernel"><img class="relatedPosts_cover lozad"data-src="https://i0.hippopx.com/photos/110/657/220/fox-animal-wildlife-red-thumb.jpg"><div class="relatedPosts_title">MIT6.828-OS-lab1:BIOS、boot和kernel</div></a></div><div class="relatedPosts_item"><a href="/2020/02/04/MIT6-828-OS-lab5/" title="MIT6-828-OS-lab5:至关重要的文件的系统-简化版"><img class="relatedPosts_cover lozad"data-src="https://i0.hippopx.com/photos/856/151/610/panorama-sunrise-dawn-bled-preview.jpg"><div class="relatedPosts_title">MIT6-828-OS-lab5:至关重要的文件的系统-简化版</div></a></div></div><div class="clear_both"></div></div></div></div><footer style="background-image: url(https://i0.hippopx.com/photos/262/885/283/sunset-boat-sea-ship-thumb.jpg)"><div id="footer"><div class="copyright">&copy;2018 - 2020 By Autumn-Cat</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/nightshift.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end --></body></html>